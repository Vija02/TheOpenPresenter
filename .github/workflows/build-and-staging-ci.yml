name: Build and Deploy Staging

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy (for manual trigger)'
        required: false
        type: string
  schedule:
    # Run daily at midnight UTC to clean up expired environments
    - cron: '0 0 * * *'

concurrency:
  group: staging-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: false

env:
  SPRITES_API_URL: https://api.sprites.dev/v1
  SPRITE_NAME_PREFIX: theopenpresenter-staging-pr
  REGISTRY: ghcr.io
  IMAGE_NAME: theopenpresenter_server

jobs:
  # Build Docker image for PRs and main branch pushes
  build:
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.docker-build.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push Docker image
        id: docker-build
        uses: ./.github/actions/docker-build
        with:
          image_name: ${{ env.IMAGE_NAME }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dockerfile: production.Dockerfile
          build_args: SHA=${{ github.sha }}
          cache_registry: ghcr.io/vija02/theopenpresenter_server:buildcache
          push_cache: ${{ github.event_name == 'push' && 'true' || 'false' }}

  # Deploy staging environment for PRs
  deploy:
    if: >
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      pull-requests: write

    outputs:
      sprite_url: ${{ steps.staging-deploy.outputs.sprite_url }}
      sprite_name: ${{ steps.vars.outputs.sprite_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: Could not determine PR number"
            exit 1
          fi
          
          SPRITE_NAME="${{ env.SPRITE_NAME_PREFIX }}-${PR_NUMBER}"
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "sprite_name=${SPRITE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR Number: ${PR_NUMBER}"
          echo "Sprite Name: ${SPRITE_NAME}"
          echo "Image Tag: pr-${PR_NUMBER}"

      - name: Deploy staging environment
        id: staging-deploy
        uses: ./.github/actions/staging-deploy
        with:
          sprites_api_url: ${{ env.SPRITES_API_URL }}
          sprites_token: ${{ secrets.SPRITES_TOKEN }}
          sprite_name: ${{ steps.vars.outputs.sprite_name }}
          image_tag: ${{ steps.vars.outputs.image_tag }}

      - name: Comment on PR with staging URL
        uses: actions/github-script@v7
        with:
          script: |
            const spriteUrl = '${{ steps.staging-deploy.outputs.sprite_url }}';
            const prNumber = ${{ steps.vars.outputs.pr_number }};
            
            // Find and delete previous staging environment comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            for (const comment of comments.data) {
              if (comment.body.includes('ðŸš€ Staging Environment Deployed')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                });
              }
            }
            
            // Add new comment
            const body = [
              '## ðŸš€ Staging Environment Deployed',
              '',
              'Your staging environment is ready!',
              '',
              `**URL:** ${spriteUrl}`,
              '',
              '**Note:** This environment will be automatically destroyed:',
              '- When this PR is closed or merged',
              '- After 7 days of inactivity',
              '- When new commits are pushed (a new environment will be created)',
              '',
              'To manually recreate the environment, re-run the "Build and Deploy Staging" workflow.',
              '',
              '---',
              `*Deployed at: ${new Date().toISOString()}*`,
              `*Commit: ${context.sha}*`
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # Cleanup when PR is closed or merged
  cleanup:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          SPRITE_NAME="${{ env.SPRITE_NAME_PREFIX }}-${PR_NUMBER}"
          echo "sprite_name=${SPRITE_NAME}" >> $GITHUB_OUTPUT

      - name: Cleanup staging environment
        uses: ./.github/actions/staging-cleanup
        with:
          sprites_api_url: ${{ env.SPRITES_API_URL }}
          sprites_token: ${{ secrets.SPRITES_TOKEN }}
          sprite_name: ${{ steps.vars.outputs.sprite_name }}

      - name: Comment on PR about cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ§¹ Staging Environment Destroyed
              
              The staging environment for this PR has been cleaned up.
              
              ---
              *Cleaned up at: ${new Date().toISOString()}*`
            });

  # Scheduled cleanup for expired environments (7 days)
  scheduled-cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List and cleanup expired sprites
        uses: actions/github-script@v7
        env:
          SPRITES_TOKEN: ${{ secrets.SPRITES_TOKEN }}
          SPRITES_API_URL: ${{ env.SPRITES_API_URL }}
          SPRITE_NAME_PREFIX: ${{ env.SPRITE_NAME_PREFIX }}
        with:
          script: |
            const https = require('https');
            const { execSync } = require('child_process');
            
            const EXPIRATION_DAYS = 7;
            const now = new Date();
            const expirationThreshold = new Date(now.getTime() - EXPIRATION_DAYS * 24 * 60 * 60 * 1000);
            
            console.log(`Checking for sprites older than ${EXPIRATION_DAYS} days (before ${expirationThreshold.toISOString()})`);
            
            // Get list of open PRs
            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const openPRNumbers = new Set(openPRs.map(pr => pr.number));
            console.log(`Open PRs: ${Array.from(openPRNumbers).join(', ')}`);
            
            // For each open PR, check if its staging environment should be cleaned up
            for (const prNumber of openPRNumbers) {
              const spriteName = `${process.env.SPRITE_NAME_PREFIX}-${prNumber}`;
              
              try {
                // Try to get the deployment timestamp from the sprite
                const timestampResult = execSync(
                  `curl -s -X POST "${process.env.SPRITES_API_URL}/sprites/${spriteName}/exec" -H "Authorization: Bearer ${process.env.SPRITES_TOKEN}" -H "Content-Type: application/json" -d '{"cmd": ["cat", "/tmp/deployment_timestamp"]}'`,
                  { encoding: 'utf-8', timeout: 30000 }
                ).trim();
                
                if (timestampResult) {
                  const deploymentDate = new Date(timestampResult);
                  
                  if (deploymentDate < expirationThreshold) {
                    console.log(`Sprite ${spriteName} is expired (deployed at ${deploymentDate.toISOString()}). Destroying...`);
                    
                    // Destroy the sprite
                    execSync(
                      `curl -s -X DELETE "${process.env.SPRITES_API_URL}/sprites/${spriteName}" -H "Authorization: Bearer ${process.env.SPRITES_TOKEN}"`,
                      { encoding: 'utf-8', timeout: 30000 }
                    );
                    
                    // Comment on the PR
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      body: `## â° Staging Environment Expired
                      
                      The staging environment for this PR has been automatically destroyed after ${EXPIRATION_DAYS} days.
                      
                      To recreate it, re-run the "Build and Deploy Staging" workflow or push a new commit.
                      
                      ---
                      *Expired at: ${new Date().toISOString()}*`
                    });
                    
                    console.log(`Sprite ${spriteName} destroyed and PR commented.`);
                  } else {
                    console.log(`Sprite ${spriteName} is still valid (deployed at ${deploymentDate.toISOString()}).`);
                  }
                }
              } catch (error) {
                console.log(`Could not check sprite ${spriteName}: ${error.message}`);
              }
            }
            
            console.log('Scheduled cleanup completed.');
